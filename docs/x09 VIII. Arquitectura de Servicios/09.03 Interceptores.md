# Interceptores

HttpClient admite una forma de middleware conocido como interceptores 
- Los interceptores son middleware que permiten abstraer patrones comunes de reintento, almacenamiento en caché, registro y autenticación de solicitudes individuales.

![Interceptores](![](https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xVKDARHiTtgOo76mnuPAUw.png))

Para este ejercicio vamos a implementar un interceptor que valide un token JSON (JWT)



## 1. Crear un servidor que genere el token JWT
1. En una consola de comandos correr el  siguiente comando
```shell
	C:\sc\angular\jwt-server>npm init -y
	C:\sc\angular\jwt-server>npm install jsonwebtoken
	C:\sc\angular\jwt-server>npm install express body-parser
	C:\sc\angular\jwt-server>code .
	
```
Mostrará lo siguiente:

C:\sc\angular\jwt-server>npm init -y
Wrote to C:\sc\angular\jwt-server\package.json:
```json
{
  "name": "jwt-server",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "keywords": [],
  "author": "",
  "license": "ISC"
}

```

2. Desde Visual Studio crear el archivo `jwtserver.js`
Colocar el siguiente contenido para crear un micro servidor  de autenticación `jwt`
```javascript
const express = require('express');
const bodyParser = require('body-parser');
const jwt = require('jsonwebtoken');

const app = express();
const port = 3000;

const secretKey = 'clave-secreta';

app.use(bodyParser.json());
/*
    POST http://localhost:3000/login
    {
        "username": "admin",
        "password": "password"
    } 
    Respuesta: 
    {
     "message": "Usuario autenticado!",
     "token": "ey . . .TQ"
    }
*/
app.post('/login', (req, res) => {
  const { username, password } = req.body;

  if (username === 'admin' && password === 'password') {
    const payload = {
      userId: 12345,
      username: 'usuario:admin'
    };

    const options = {
      expiresIn: '1h' // El token expirará en 1 hora
    };

    const token = jwt.sign(payload, secretKey, options);

    res.json({
      message: 'Usuario autenticado!',
      token: token
    });
  } else {
    res.status(401).json({ message: 'Credenciales incorrectas' });
  }
});

// Ruta protegida

app.get('/protected', (req, res) => {
  const token = req.headers['authorization'];

  if (!token) {
    return res.status(403).json({ message: 'No envió el token' });
  }

  jwt.verify(token.split(' ')[1], secretKey, (err, decoded) => {
    if (err) {
      return res.status(500).json({ message: 'Error al validar el token de autenticación' });
    }

    // Si el token es válido, decodificamos el payload y enviamos una respuesta
    res.json({ message: 'Acceso autorizado', user: decoded });
  });
});

// Iniciar el servidor
app.listen(port, () => {
  console.log(`El Server está escuchando en http://localhost:${port}`);
});

```

3. Levantar el servidor jwt

```shell
C:\sc\angular\jwt-server>node jwtserver.js
```

Realizar pruebas en Postman, para obtener un token, que usará en el interceptor.
```shell
POST http://localhost:3000/login
JSON
{
	"username": "admin",
	"password": "password"
}
```


## 2. Crear el interceptor
1. En la línea de comandos del proyecto angular ejecutar el siguiente comando

```shell
ng generate interceptor core/interceptors/auth
```

Abrir el archivo generado `src\app\core\interceptors\auth.interceptor.ts`
```typescript
import { HttpInterceptorFn } from  '@angular/common/http';
export  const  authInterceptor:  HttpInterceptorFn  = (req, next) => {
	return  next(req);
};
```

2. Actualizar el contenido con el intereptor de autenticación
```typescript
import { HttpInterceptorFn } from '@angular/common/http';

// src/app/auth.interceptor.ts
import { Injectable } from '@angular/core';
import { HttpInterceptor, HttpRequest, HttpHandler, HttpEvent, HttpErrorResponse } from '@angular/common/http';
import { Observable, throwError } from 'rxjs';
import { catchError } from 'rxjs/operators';
import { Router } from '@angular/router';
import { AuthService } from './auth.service';

@Injectable()
export class AuthInterceptor implements HttpInterceptor {

  constructor(private authService: AuthService, private router: Router) {}

  intercept(req: HttpRequest<any>, next: HttpHandler): Observable<HttpEvent<any>> {
    // Obtener el token del servicio de autenticación
    const authToken = this.authService.getToken();

    // Clonar la solicitud y añadir el encabezado de autorización si el token está presente
    let authReq = req;
    if (authToken) {
      authReq = req.clone({
        headers: req.headers.set('Authorization', `Bearer ${authToken}`)
      });
    }

    // Manejar la solicitud y capturar errores
    return next.handle(authReq).pipe(
      catchError((error: HttpErrorResponse) => {
        // Si el error es 401 (Unauthorized), redirigir a la página de inicio de sesión
        if (error.status === 401) {
          this.router.navigate(['/login']);
        }
        return throwError(error);
      })
    );
  }
}
```

## 2. Crear el servicio de autenticación

1. En la línea de comandos del proyecto angular ejecutar el siguiente comando

```shell
	ng generate service core/services/auth 
```

2. Editar el archivo generado `src\app\core\services\auth.service.ts`
```typescript

```
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTEyNDcwODU2NDEsMTcyODg4ODc1LC0xND
UyMTE5NzcsLTg0MzA1OTM5NiwtMTU3ODYwMDgyOF19
-->